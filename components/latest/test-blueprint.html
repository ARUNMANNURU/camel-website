<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <title>Blueprint Testing - Apache Camel</title> <link rel="canonical" href="https://camel.apache.org/components/latest/test-blueprint.html"> <meta name="generator" content="Antora 2.1.0"> <link rel="stylesheet" href="../../_/css/site-1c739ae396.css"> <meta name="application-name" content="Apache Camel"> <link rel="manifest" href="../../site.webmanifest"> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../apple-touch-icon-57x57.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../apple-touch-icon-114x114.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../apple-touch-icon-72x72.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../apple-touch-icon-144x144.png"> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../../apple-touch-icon-60x60.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../../apple-touch-icon-120x120.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../../apple-touch-icon-76x76.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../apple-touch-icon-152x152.png"> <link rel="icon" type="image/png" href="../../favicon-196x196.png" sizes="196x196"> <link rel="icon" type="image/png" href="../../favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="../../favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="../../favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="../../favicon-128.png" sizes="128x128"> </head> <body class="article"> <header class="header"> <nav class="navbar"> <div class="navbar-brand"> <a class="nav-logo" href="../.."><span>Apache Camel</span></a> <div id="topbar-nav" class="navbar-menu"> <div class="navbar-end"> <a class="navbar-item" href="../../blog/">Blog</a> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">Projects</a> <div class="navbar-dropdown"> <a class="navbar-item" href="../../projects/camel-k/">Camel K</a> <a class="navbar-item" href="../../projects/camel-quarkus/">Camel Quarkus</a> </div> </div> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">Documentation</a> <div class="navbar-dropdown"> <a class="navbar-item" href="../../docs/getting-started/">Getting started</a> <a class="navbar-item" href="../../manual/latest/">User manual</a> <a class="navbar-item" href="../../components/latest/">Component reference</a> <a class="navbar-item" href="../../camel-k/latest/">Camel K</a> <a class="navbar-item" href="../../camel-quarkus/latest/">Camel Quarkus</a> <a class="navbar-item" href="../../manual/latest/enterprise-integration-patterns.html">Enterprise Integration Patterns</a> <a class="navbar-item" href="../../manual/latest/camel-3-migration-guide.html">Camel 3 Migration Guide</a> </div> </div> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">Community</a> <div class="navbar-dropdown"> <a class="navbar-item" href="../../community/support/">Support</a> <a class="navbar-item" href="https://github.com/apache/camel/blob/master/CONTRIBUTING.md">Contributing</a> <a class="navbar-item" href="../../community/user-stories/">User stories</a> <a class="navbar-item" href="../../community/articles/">Articles</a> <a class="navbar-item" href="../../community/books/">Books</a> <a class="navbar-item" href="../../community/team/">Team</a> </div> </div> <a class="navbar-item" href="../../download/">Download</a> <div class="navbar-item has-dropdown is-hoverable"> <a class="navbar-link" href="#">About</a> <div class="navbar-dropdown"> <a class="navbar-item" href="https://www.apache.org/events/current-event.html">Apache events</a> <a class="navbar-item" href="https://www.apache.org/licenses/">License</a> <a class="navbar-item" href="../../security/">Security</a> <a class="navbar-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a> <a class="navbar-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a> </div> </div> </div> </div> <div class="navbar-tools"> <a href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg class="brand-icon"><use xlink:href="../../_/img/brand-logos.svg#github"/></svg></a> <a href="https://gitter.im/apache/apache-camel" title="Chat on Gitter"><svg class="brand-icon"><use xlink:href="../../_/img/brand-logos.svg#gitter"/></svg></a> <a href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg class="brand-icon"><use xlink:href="../../_/img/brand-logos.svg#twitter"/></svg></a> </div> <button class="navbar-burger" data-target="topbar-nav" type="button"> <span></span> <span></span> <span></span> </button> </div> </nav> </header> <div class="body"> <div class="nav-container" data-component="components" data-version="latest"> <aside class="nav"> <div class="panels"> <div class="nav-panel-explore is-active" data-panel="explore"> <div class="context"> <span class="title">Component reference</span> <span class="version">latest</span> </div> <ul class="components"> <li class="component"> <span class="title">Apache Camel extensions for Quarkus</span> <ul class="versions"> <li class="version is-latest"> <a href="../../camel-quarkus/latest/index.html">latest</a> </li> </ul> </li> <li class="component"> <span class="title">Apache Camel K</span> <ul class="versions"> <li class="version is-latest"> <a href="../../camel-k/latest/index.html">latest</a> </li> </ul> </li> <li class="component is-current"> <span class="title">Component reference</span> <ul class="versions"> <li class="version is-current is-latest"> <a href="index.html">latest</a> </li> <li class="version"> <a href="../2.x/index.html">2.x</a> </li> </ul> </li> <li class="component"> <span class="title">User manual</span> <ul class="versions"> <li class="version is-latest"> <a href="../../manual/latest/index.html">latest</a> </li> </ul> </li> </ul> </div> </div> </aside> </div> <main role="main"> <div class="toolbar" role="navigation"> <button class="nav-toggle"></button> <a href="../../manual/latest/index.html" class="home-link"></a> <nav class="breadcrumbs" aria-label="breadcrumbs"> <ul> <li><a href="index.html">Component reference</a></li> <li><a href="test-blueprint.html">Blueprint Testing</a></li> </ul> </nav> <div class="page-versions"> <button class="version-menu-toggle" title="Show other versions of page" type="button">latest</button> <div class="version-menu"> <a class="version is-current" href="test-blueprint.html">latest</a> <a class="version" href="../2.x/test-blueprint.html">2.x</a> </div> </div> <div class="edit-this-page"><a href="https://github.com/apache/camel/edit/master/components/camel-test-blueprint/src/main/docs/test-blueprint.adoc">Edit this Page</a></div> </div> <article class="doc"> <h1 class="page">Blueprint Testing</h1> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p><strong>Available as of Camel 2.10</strong></p> </div> <div class="paragraph"> <p>camel-test-blueprint does only support testing <em>one</em> CamelContext. So if you have two or more CamelContexts in your blueprint XML files, then only the CamelContext first found is used during testing.</p> </div> <div class="paragraph"> <p>Testing is a crucial part of any development or integration work. Camel supports the definition of Blueprint routes, but given that Blueprint is an OSGi specific technology, writing unit tests is quite difficult. This library leverages <a href="http://code.google.com/p/pojosr/">PojoSR</a> (now Felix Connect) which provides a service registry without using a fully compliant OSGi container. This allows defining real unit tests (as opposed to integration tests using <a href="http://team.ops4j.org/wiki/display/paxexam/Pax+Exam">Pax Exam</a>. Please make sure all test jars in your classpath are OSGi bundles.</p> </div> <div class="paragraph"> <p>Also notice the use of <strong><code>getBlueprintDescriptor</code></strong> to specify the location of the OSGi Blueprint XML file.<br> If you have multiple OSGi Blueprint XML files, then you can specify them with a comma-separated list in the <strong><code>getBlueprintDescriptor</code></strong> method. Notice that only <strong>one</strong> <code>CamelContext</code> is supported per blueprint bundle, so if you have multiple XML files then only one of them should have <code>&lt;camelContext&gt;</code>.</p> </div> <div class="paragraph"> <p>Here&#8217;s the <a href="http://svn.apache.org/viewvc/camel/trunk/components/camel-test-blueprint/src/test/resources/org/apache/camel/test/blueprint/camelContext.xml?view=markup">Blueprint XML file</a>:</p> </div> <div class="paragraph"> <p>In order to define blueprint tests, add the following dependency to your pom:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
  &lt;artifactId&gt;camel-test-blueprint&lt;/artifactId&gt;
  &lt;version&gt;2.10&lt;/version&gt;
  &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="_classpath_scanning"><a class="anchor" href="#_classpath_scanning"></a>Classpath scanning</h2> <div class="sectionbody"> <div class="paragraph"> <p>By default PojoSR test container scans the test classpath for all the OSGi bundles available there. All the bundles with Blueprint descriptor files will be automatically started by the test container. If you would like to prevent particular bundles from being started by the test container, override the <code>getBundleFilter</code> method, just as demonstrated in the snippet below.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
protected String getBundleFilter() {
  // I don't want test container to scan and load Logback bundle during the test
  return "(!(Bundle-SymbolicName=ch.qos.logback.core))";
}</code></pre> </div> </div> <div class="paragraph"> <p>Keep in mind that not specifying the Blueprint descriptor in the getBlueprintDescriptor method will not prevent the test container from loading a given descriptor. The <code>getBundleFilter</code> method is the proper way of filtering out bundles you don&#8217;t want to start during the test.</p> </div> </div> </div> <div class="sect1"> <h2 id="_setting_timeout_when_getting_camelcontext"><a class="anchor" href="#_setting_timeout_when_getting_camelcontext"></a>Setting timeout when getting CamelContext</h2> <div class="sectionbody"> <div class="paragraph"> <p><strong>Available as of Camel 2.13.0/2.12.1/2.11.2</strong></p> </div> <div class="paragraph"> <p><code>CamelBlueprintTestSupport</code> waits 30 seconds for Camel Context to be ready by default, now you can override this value in two ways:</p> </div> <div class="ulist"> <ul> <li> <p>Globally, by setting <code>org.apache.camel.test.blueprint.camelContextCreationTimeout</code> system property.</p> </li> <li> <p>Locally for each test, by overriding <em>getCamelContextCreationTimeout</em> method.</p> </li> </ul> </div> </div> </div> <div class="sect1"> <h2 id="_adding_services_on_startup"><a class="anchor" href="#_adding_services_on_startup"></a>Adding services on startup</h2> <div class="sectionbody"> <div class="paragraph"> <p><strong>Available as of Camel 2.11.2/2.12.0</strong></p> </div> <div class="paragraph"> <p>When using <code>camel-test-blueprint</code> you may do unit tests which requires using shared services which are not available during unit testing, but only in the real OSGi container, for example a shared <code>DataSource</code>.</p> </div> <div class="paragraph"> <p>To make it easier to register services on startup, such as a standalone <code>DataSource</code> or any other service, you can override the method <code>addServicesOnStartup</code> when your unit test class extends <code>CamelBlueprintTestSupport</code>.</p> </div> <div class="paragraph"> <p>In the example below we register a service <code>org.apache.camel.test.blueprint.MyService</code> using the name <code>myService</code> having a property <code>beer=Carlsberg</code>, as shown below:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Override
    protected void addServicesOnStartup(Map&lt;String, KeyValueHolder&lt;Object, Dictionary&gt;&gt; services) {
        services.put("myService", asService(myService, "beer", "Carlsberg"));
    }</code></pre> </div> </div> <div class="paragraph"> <p>The asService is a builder method that makes it easy to register a service with a single property. If you need more properties you can use the <code>asService</code> method that takes a <code>Dictionary</code> as argument. And if you do not need any properties, then just pass in <code>null</code>, eg:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">services.put("myService", asService(myService, null));</code></pre> </div> </div> <div class="paragraph"> <p>This allows us to use the service by calling a method on it from a Camel <a href="bean-component.html" class="page">Bean</a> component in a route as shown:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;route&gt;
      &lt;from uri="direct:start"/&gt;
      &lt;to uri="bean:myService"/&gt;
      &lt;to uri="mock:result"/&gt;
    &lt;/route&gt;</code></pre> </div> </div> <div class="paragraph"> <p>Notice the bean endpoint uses the service name <code>myService</code> which was the name we registered the service as. You can also use the fully qualified class name instead, which is more common with OSGi.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Override
    protected void addServicesOnStartup(Map&lt;String, KeyValueHolder&lt;Object, Dictionary&gt;&gt; services) {
        services.put(MyService.class.getName(), asService(myService, "beer", "Carlsberg"));
    }</code></pre> </div> </div> <div class="paragraph"> <p>And in the route we use the FQN name:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;route&gt;
      &lt;from uri="direct:start"/&gt;
      &lt;to uri="bean:org.apache.camel.test.blueprint.MyService"/&gt;
      &lt;to uri="mock:result"/&gt;
    &lt;/route&gt;</code></pre> </div> </div> <div class="paragraph"> <p>From <strong>Camel 2.16.0</strong>, an additional <code>addServicesOnStartup</code> method is available to be overridden making it ideal for when needing to specify multiple services with the same interface.</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">  @Override
  protected void addServicesOnStartup(List&lt;KeyValueHolder&lt;String, KeyValueHolder&lt;Object, Dictionary&gt;&gt;&gt; services) {
      Dictionary&lt;String, String&gt; dict1 = new Hashtable&lt;String, String&gt;();
      dict1.put("osgi.jndi.service.name", "jdbc/db1");

      Dictionary&lt;String, String&gt; dict2 = new Hashtable&lt;String, String&gt;();
      dict2.put("osgi.jndi.service.name", "jdbc/db2");

      services.add(asKeyValueService(javax.sql.DataSource.class.getName(), mockService1, dict1));
      services.add(asKeyValueService(javax.sql.DataSource.class.getName(), mockService2, dict2));
    }</code></pre> </div> </div> <div class="paragraph"> <p>The <code>asKeyValueService</code> builder method can be used to construct the necessary parameters to create the service. The method takes in the name of the registered service, the object, and and a <code>Dictionary</code> as arguments.</p> </div> </div> </div> </article> </main> </div> <footer> <div class="footer"> <figure class="logo"> <img src="../../_/img/logo-d.svg" class="logo-small mt-60" alt="Apache Camel Logo" aria-label="white silhouette of a camel in front of a sand dune"> </figure> <dl> <dt>Overview</dt> <dd><a href="../../blog/">Blog</a></dd> <dd><a href="../../components/latest/">Components</a></dd> <dd><a href="../../download/">Download</a></dd> <dd><a href="../../docs/getting-started/">Getting started</a></dd> <dd><a href="../../manual/latest/faq.html">FAQ</a></dd> </dl> <dl> <dt>Community</dt> <dd><a href="../../community/support/">Support</a></dd> <dd><a href="https://github.com/apache/camel/blob/master/CONTRIBUTING.md">Contributing</a></dd> <dd><a href="../../community/user-stories/">User stories</a></dd> <dd><a href="../../community/articles/">Articles</a></dd> <dd><a href="../../community/books/">Books</a></dd> <dd><a href="../../community/team/">Team</a></dd> </dl> <dl> <dt>About</dt> <dd><a href="../../acknowledgments/">Acknowledgments</a> </dd><dd><a target="_blank" href="https://www.apache.org/events/current-event.html" title="Apache Events">Apache Events</a></dd> <dd><a target="_blank" href="https://www.apache.org/licenses/" title="License">License</a></dd> <dd><a target="_blank" href="https://www.apache.org/security/" title="Security">Security</a></dd> <dd><a target="_blank" href="https://www.apache.org/foundation/sponsorship.html" title="Sponsorship">Sponsorship</a></dd> <dd><a target="_blank" href="https://www.apache.org/foundation/thanks.html" title="Thanks">Thanks</a></dd> </dl> <p> &copy; 2004-2019 The <a href="https://apache.org">Apache Software Foundation</a>.<br> Apache Camel, Camel, Apache, the Apache feather logo, and the Apache Camel project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners. </p> </div> </footer> <script src="../../_/js/site-f4f4dbc142.js"></script> <script async src="../../_/js/vendor/highlight-54157f17f1.js"></script> <script async src="../../_/js/vendor/svg4everybody-195d47ce7d.js"></script> <script type="application/ld+json"> {
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "Apache Camel",
  "url": "https://camel.apache.org",
  "sameAs": [
     "https://twitter.com/ApacheCamel"
  ],
  "logo": "../../_/img/logo-d.svg",
  "description": "Apache Camel ™ is a versatile open-source integration framework based on known Enterprise Integration Patterns. Camel empowers you to define routing and mediation rules in a variety of domain-specific languages, including a Java-based Fluent API, Spring or Blueprint XML Configuration files, and a Scala DSL."
} </script> <script type="application/ld+json"> { 
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "Apache Camel",
        "item": "https://camel.apache.org"
        },
        {
        "@type": "ListItem",
        "position": 2,
        "name": "Component reference",
        "item": "https://camel.apache.org/components/latest/index.html"
        },
        {
        "@type": "ListItem",
        "position": 3,
        "name": "Blueprint Testing","item": "https://camel.apache.org/components/latest/test-blueprint.html"}
        ]
    } </script> </body> </html> 