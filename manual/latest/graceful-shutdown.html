<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Untitled :: Apache Camel</title><link rel="canonical" href="https://camel.apache.org/manual/latest/graceful-shutdown.html"><meta name="generator" content="Antora 2.0.0"><link rel="stylesheet" href="../../_/css/site.css"></head><body class="article"><header class="header"><nav class="navbar shadow border-bottom"><div class="navbar-brand"><a class="navbar-item nav-logo" href="https://camel.apache.org" title="Apache Camel"></a><button class="navbar-burger" data-target="topbar-nav"><span></span><span></span><span></span></button></div><div id="topbar-nav" class="navbar-menu"><div class="navbar-end"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/news/">News</a><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Projects</a><div class="navbar-dropdown"><a class="navbar-item" href="/projects/camel-k/">Camel K</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Documentation</a><div class="navbar-dropdown"><a class="navbar-item" href="/docs/getting-started/">Getting started</a><a class="navbar-item" href="/manual/latest/">User manual</a><a class="navbar-item" href="/components/latest/">Component reference</a><a class="navbar-item" href="/camel-k/latest/">Camel K</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Community</a><div class="navbar-dropdown"><a class="navbar-item" href="/community/support/">Support</a><a class="navbar-item" href="https://github.com/apache/camel/blob/master/CONTRIBUTING.md">Contributing</a><a class="navbar-item" href="/community/user-stories/">User stories</a><a class="navbar-item" href="/community/articles/">Articles</a><a class="navbar-item" href="/community/books/">Books</a><a class="navbar-item" href="/community/team/">Team</a><a class="navbar-item" href="/community/camel-extra/">Camel extra</a></div></div><a class="navbar-item" href="/download/">Download</a><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">About</a><div class="navbar-dropdown"><a class="navbar-item" href="https://www.apache.org/events/current-event.html">Apache events</a><a class="navbar-item" href="https://www.apache.org/licenses/">License</a><a class="navbar-item" href="https://www.apache.org/security/">Security</a><a class="navbar-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a><a class="navbar-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></div></div></div></div></nav></header><div class="main-wrapper"><div class="navigation-container" data-component="manual" data-version="latest"><aside class="navigation"><div class="panels"><div class="navigation-menu is-active" data-panel="menu"><nav class="nav-menu"><h3 class="title"><a href="index.html">User manual</a></h3><ul class="nav-list"><li class="nav-item" data-depth="0"><ul class="nav-list"><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="getting-started.html">Getting started</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="book-getting-started.html">Getting Started with Apache Camel</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="architecture.html">Architecture</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="async.html">Async</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="asynchronous-routing-engine.html">Asynchronous Routing Engine</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="backlogdebugger.html">Backlog debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bam.html">Business Activity Monitoring</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="batch-consumer.html">Batch Consumer</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="browsable-endpoint.html">BrowsableEndpoint</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camel-core.html">Core</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camelcontext.html">Context</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="endpoint.html">Endpoints</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="cep.html">Complex Event Processing</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="component.html">Component</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="debugger.html">Debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="delay-interceptor.html">Delay interceptor</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dependency-injection.html">Dependency Injection</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dozer-type-conversion.html">Dozer Type Conversion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bean-integration.html">Bean Integration</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="error-handler.html">Error Handler</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange.html">Message Exchange</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange-pattern.html">Exchange Pattern</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="expression.html">Expressions</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="injector.html">Injector</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="intercept.html">Intercept</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="inversion-of-control-with-smart-defaults.html">Inversion Of Control With Smart Defaults</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="jmx.html">JMX</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="lifecycle.html">Camel Lifecycle</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="oncompletion.html">OnCompletion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="predicate.html">Predicates</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="registry.html">Registry</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="route-builder.html">RouteBuilder</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="routes.html">Routes</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><span class="nav-text">Domain Specific Languages</span><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="dsl.html">Camel Domain Specific Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="java-dsl.html">Java DSL</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="spring.html">Spring support</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="groovy-dsl.html">Groovy DSL</a></li></ul></li><li class="nav-item" data-depth="1"><a class="nav-link" href="using-osgi-blueprint-with-camel.html">Using OSGi blueprint with Camel</a></li></ul></li></ul></nav></div><div class="navigation-explore" data-panel="explore"><div class="context"><span class="title">User manual</span><span class="version">latest</span></div><ul class="components"><li class="component"><span class="title">Apache Camel K</span><ul class="versions"><li class="version is-latest"><a href="../../camel-k/latest/index.html">latest</a></li></ul></li><li class="component"><span class="title">Component reference</span><ul class="versions"><li class="version is-latest"><a href="../../components/latest/index.html">latest</a></li></ul></li><li class="component is-current"><span class="title">User manual</span><ul class="versions"><li class="version is-current is-latest"><a href="index.html">latest</a></li></ul></li></ul></div></div></aside></div><main class="main"><div class="toolbar" role="navigation"><button class="navigation-toggle"></button><a href="index.html" class="home-link"></a><nav class="crumbs" aria-label="breadcrumbs"></nav><div class="edit-this-page"><a href="https://github.com/apache/camel/edit/master/docs/user-manual/modules/ROOT/pages/graceful-shutdown.adoc">Edit this Page</a></div></div><article class="doc"><div class="sect2"><h3 id="GracefulShutdown-GracefulShutdown"><a class="anchor" href="#GracefulShutdown-GracefulShutdown"></a>Graceful Shutdown</h3><div class="paragraph"><p><strong>Available as of Camel 2.2</strong></p></div><div class="paragraph"><p>Camel now supports a pluggable shutdown strategy using<code>org.apache.camel.spi.ShutdownStrategy</code>. Its responsible for shutting down routes in a graceful manner. The other resources will still be handled by<a href="camelcontext.html">CamelContext</a>to shutdown. This leaves the problem at hand with properly shutting down all the routes in a reliable manner to the<code>ShutdownStrategy</code>.</p></div><div class="paragraph"><p>Camel provides a default strategy in the<code>org.apache.camel.impl.DefaultShutdownStrategy</code>which is capable of doing that.</p></div><div class="sect3"><h4 id="GracefulShutdown-DefaultShutdownStrategy"><a class="anchor" href="#GracefulShutdown-DefaultShutdownStrategy"></a>DefaultShutdownStrategy</h4><div class="paragraph"><p>The default strategy will gracefully shutdown routes:</p></div><div class="ulist"><ul><li><p><strong>Camel 2.2:</strong>in the same order they was started</p></li><li><p><strong>Camel 2.3:</strong>in the reverse order they was started. The option<code>shutdownRoutesInReverseOrder</code>can be used to use the old behavior.</p></li><li><p>let pending and current in flight exchanges run to completion before shutting down</p></li><li><p>using a timeout of 300 seconds which then forces a shutdown now</p></li></ul></div><div class="paragraph"><p>You can configure the timeout, and whether it should shutdown now remaining routes when the timeout occurred or ignore. See the setters on the class.</p></div><div class="paragraph"><p>It will output to log the progress during graceful shutdown as shown in an example below</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">2009-12-20 10:56:53,055 [main ] INFO DefaultCamelContext - Apache Camel
(CamelContext:camel-1) is stopping 2009-12-20 10:56:53,056 [main ] INFO
DefaultShutdownStrategy - Starting to graceful shutdown routes (timeout
300 seconds) 2009-12-20 10:56:53,059 [1: ShutdownTask] INFO
DefaultShutdownStrategy - Waiting as there are still 5 inflight
exchanges to complete before we can shutdown 2009-12-20 10:56:54,060 [1:
ShutdownTask] INFO DefaultShutdownStrategy - Waiting as there are still
4 inflight exchanges to complete before we can shutdown 2009-12-20
10:56:55,061 [1: ShutdownTask] INFO DefaultShutdownStrategy - Waiting as
there are still 3 inflight exchanges to complete before we can shutdown
2009-12-20 10:56:56,065 [1: ShutdownTask] INFO DefaultShutdownStrategy -
Waiting as there are still 2 inflight exchanges to complete before we
can shutdown 2009-12-20 10:56:57,066 [1: ShutdownTask] INFO
DefaultShutdownStrategy - Waiting as there are still 1 inflight
exchanges to complete before we can shutdown 2009-12-20 10:56:58,069
[main ] INFO DefaultShutdownStrategy - Graceful shutdown of routes
complete in 5 seconds. 2009-12-20 10:56:58,072 [main ] INFO
DefaultInflightRepository - Shutting down with no inflight exchanges.
2009-12-20 10:56:58,077 [main ] INFO DefaultCamelContext - Apache Camel
(CamelContext:camel-1) stopped</code></pre></div></div><div class="paragraph"><p>Notice how it waits while there are inflight exchanges still being processed before it can shutdown.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-Suppressingloggingduetotimeoutnotallowingallinflightmessagestocomplete"><a class="anchor" href="#GracefulShutdown-Suppressingloggingduetotimeoutnotallowingallinflightmessagestocomplete"></a>Suppressing logging due to timeout not allowing all inflight messages to complete</h4><div class="paragraph"><p><strong>Available as of Camel 2.12</strong></p></div><div class="paragraph"><p>If a graceful shutdown could not shutdown cleanly within the given timeout period, then Camel performs a more aggressive shutdown by forcing routes and thread pools etc to shutdown. And as well the routing engine will reject continue processing<a href="exchange.adoc">Exchange</a>s. If this happens you may see WARN logs about<a href="exchange.adoc">Exchange</a>s being rejected and other failures due the forced shutdown.</p></div><div class="paragraph"><p>If you do not want to see these logs, you can suppress this by setting the option SuppressLoggingOnTimeout to true.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">context.getShutdownStrategy().setSuppressLoggingOnTimeout(true);</code></pre></div></div><div class="paragraph"><p>Notice the suppress is a "best effort" though there may still be some logs coming from 3rd party libraries and whatnot, which Camel cannot control.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-Logginginflightexchangeinformationontimeout"><a class="anchor" href="#GracefulShutdown-Logginginflightexchangeinformationontimeout"></a>Logging inflight exchange information on timeout</h4><div class="paragraph"><p><strong>Available as of Camel 2.15</strong></p></div><div class="paragraph"><p>If a graceful shutdown could not shutdown cleanly within the given timeout period, then Camel performs a more aggressive shutdown by forcing routes and thread pools etc to shutdown. When the timeout happens, then Camel logs information about the current inflight exchanges, which shows from which route the exchange origins, and where it currently is being routed. For example the logging below, shows that there is 1 inflight exchange, that origins from route1, and currently is still in route1 at the "delay1" node. The elapsed is time in millis how long at the current node (eg delay1) and duration is total time in mills.</p></div><div class="paragraph"><p>If you enable DEBUG logging level on <code>org.apache.camel.impl.DefaultShutdownStrategy</code>then it logs the same inflight exchange information during graceful shutdown</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">2015-01-12 13:23:23,656 [ - ShutdownTask] INFO DefaultShutdownStrategy -
There are 1 inflight exchanges: InflightExchange:
[exchangeId=ID-davsclaus-air-62213-1421065401253-0-3,
fromRouteId=route1, routeId=route1, nodeId=delay1, elapsed=2007,
duration=2017]</code></pre></div></div><div class="paragraph"><p>If you do not want to see these logs, you can turn this off by setting the option logInflightExchangesOnTimeout to false.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">context.getShutdownStrategy().setLogInflightExchangesOnTimeout(false);</code></pre></div></div></div><div class="sect3"><h4 id="GracefulShutdown-Controllingorderingofroutes"><a class="anchor" href="#GracefulShutdown-Controllingorderingofroutes"></a>Controlling ordering of routes</h4><div class="paragraph"><p>You can configure the order in which routes should be started, and thus also the same order they are being shutdown. See more at<a href="configuring-route-startup-ordering-and-autostartup.adoc">Configuring route startup ordering and autostartup</a>.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-Finegrainedconfiguration"><a class="anchor" href="#GracefulShutdown-Finegrainedconfiguration"></a>Fine grained configuration</h4><div class="paragraph"><p>You can control two areas that influence graceful shutdown in the Camel routing:</p></div><div class="ulist"><ul><li><p><code>ShutdownRoute</code></p></li><li><p><code>ShutdownRunningTask</code></p></li></ul></div><div class="paragraph"><p>These options can be configured on two scopes:<code>context</code>and<code>route</code>. Where a route will fallback to the<code>context</code>scoped option, if not explicit configured. (same principle as<a href="error-handler.html">Error Handler</a>, etc.).</p></div></div><div class="sect3"><h4 id="GracefulShutdown-ShutdownRoute"><a class="anchor" href="#GracefulShutdown-ShutdownRoute"></a>ShutdownRoute</h4><div class="paragraph"><p>This option can control how a given route should act during graceful shutdown. It has two values<code>Default</code>and<code>Defer</code>. The<code>Default</code>is obviously the default option which lets Camel shutdown the route as early as possible. The<code>Defer</code>is used to defer shutting down this route to a later stage. This is useful when other routes are dependent upon it. For example an internal route which other routes reuse.</p></div><div class="paragraph"><p>For example in the route below we have two routes, where route 1 is dependent upon route 2. At shutdown we want route 1 to complete all its current messages and we also want the 2nd route to do this as well. So we can mark both routes to<code>Defer</code>but since route 1 is a<a href="#seda-component">SEDA</a>based route its<code>Defer</code>by default (it uses<code>ShutdownAware</code>).</p></div><div class="paragraph"><p>A Java DSL based example to defer shutting down the 2nd</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.apache.camel.processor;

import java.io.File;
import java.util.concurrent.atomic.AtomicBoolean;

import org.apache.camel.Component;
import org.apache.camel.ContextTestSupport;
import org.apache.camel.Processor;
import org.apache.camel.builder.RouteBuilder;
import org.apache.camel.component.file.FileConsumer;
import org.apache.camel.component.file.FileEndpoint;
import org.apache.camel.component.file.GenericFileOperations;
import org.apache.camel.component.mock.MockEndpoint;
import org.junit.Before;
import org.junit.Test;

import static org.apache.camel.ShutdownRoute.Defer;

public class ShutdownDeferTest extends ContextTestSupport {

    private static final AtomicBoolean CONSUMER_SUSPENDED = new AtomicBoolean();

    @Override
    @Before
    public void setUp() throws Exception {
        deleteDirectory("target/deferred");
        super.setUp();
    }

    @Test
    public void testShutdownDeferred() throws Exception {
        MockEndpoint bar = getMockEndpoint("mock:bar");
        bar.expectedMinimumMessageCount(1);

        template.sendBody("seda:foo", "A");
        template.sendBody("seda:foo", "B");
        template.sendBody("seda:foo", "C");
        template.sendBody("seda:foo", "D");
        template.sendBody("seda:foo", "E");

        assertMockEndpointsSatisfied();

        Thread.sleep(50);

        context.stop();

        assertFalse("Should not have been suspended", CONSUMER_SUSPENDED.get());
    }

    @Override
    protected RouteBuilder createRouteBuilder() throws Exception {
        return new RouteBuilder() {
            @Override
            // START SNIPPET: e1
            public void configure() throws Exception {
                from("seda:foo")
                    .startupOrder(1)
                    .to("file://target/deferred");

                // use file component to transfer files from route 1 -&gt; route 2 as it
                // will normally suspend, but by deferring this we can let route 1
                // complete while shutting down
                MyDeferFileEndpoint defer = new MyDeferFileEndpoint("file://target/deferred?initialDelay=0&amp;delay=10", getContext().getComponent("file"));
                defer.setFile(new File("target/deferred"));

                from(defer)
                    // defer shutting down this route as the 1st route depends upon it
                    .startupOrder(2).shutdownRoute(Defer)
                    .to("mock:bar");
            }
            // END SNIPPET: e1
        };
    }

    private static final class MyDeferFileEndpoint extends FileEndpoint {

        private MyDeferFileEndpoint(String endpointUri, Component component) {
            super(endpointUri, component);
        }

        @Override
        protected FileConsumer newFileConsumer(Processor processor, GenericFileOperations&lt;File&gt; operations) {
            return new FileConsumer(this, processor, operations, createGenericFileStrategy()) {
                @Override
                protected void doSuspend() throws Exception {
                    CONSUMER_SUSPENDED.set(true);
                    super.doSuspend();
                }
            };
        }
    }
}</code></pre></div></div><div class="paragraph"><p>Defer shutting down internal routes only</p></div><div class="paragraph"><p>Its best to only defer shutting down internal routes only. As<strong>public</strong>routes should shutdown as quickly as possible otherwise it will just keep intake new messages which will delay the shutdown processor. Or even have it timeout if a lot of new messages keep coming in.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-ShutdownRunningTask"><a class="anchor" href="#GracefulShutdown-ShutdownRunningTask"></a>ShutdownRunningTask</h4><div class="paragraph"><p>This option control how a given route consumer acts during shutdown. Most route consumer will only operate on a single task (message), however the<a href="batch-consumer.html">Batch Consumer</a>can operate on many messages (in a batch). This option is for those kind of consumers. By default it uses the option<code>CompleteCurrentTaskOnly</code>which mean that the current<em>in progress</em>task (message) will be completed and then the consumer will shutdown. The other option<code>CompleteAllTasks</code>allows the consumer to complete all the tasks (messages) before shutting down. For example a<a href="file2.html">File</a>consumer will process all the pending files it has picked up before shutting down.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.apache.camel.processor;

import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicInteger;

import org.apache.camel.ContextTestSupport;
import org.apache.camel.Exchange;
import org.apache.camel.Processor;
import org.apache.camel.ShutdownRunningTask;
import org.apache.camel.builder.RouteBuilder;
import org.apache.camel.component.mock.MockEndpoint;
import org.junit.Before;
import org.junit.Test;

public class ShutdownCompleteAllTasksTest extends ContextTestSupport {

    private static String url = "file:target/pending?initialDelay=0&amp;delay=10";
    private static AtomicInteger counter = new AtomicInteger();
    private static CountDownLatch latch = new CountDownLatch(2);

    @Override
    @Before
    public void setUp() throws Exception {
        deleteDirectory("target/pending");
        super.setUp();

        template.sendBodyAndHeader(url, "A", Exchange.FILE_NAME, "a.txt");
        template.sendBodyAndHeader(url, "B", Exchange.FILE_NAME, "b.txt");
        template.sendBodyAndHeader(url, "C", Exchange.FILE_NAME, "c.txt");
        template.sendBodyAndHeader(url, "D", Exchange.FILE_NAME, "d.txt");
        template.sendBodyAndHeader(url, "E", Exchange.FILE_NAME, "e.txt");
    }

    @Test
    public void testShutdownCompleteAllTasks() throws Exception {
        // give it 30 seconds to shutdown
        context.getShutdownStrategy().setTimeout(30);

        // start route
        context.startRoute("foo");

        MockEndpoint bar = getMockEndpoint("mock:bar");
        bar.expectedMinimumMessageCount(1);

        assertMockEndpointsSatisfied();

        int batch = bar.getReceivedExchanges().get(0).getProperty(Exchange.BATCH_SIZE, int.class);

        // wait for latch
        latch.await(10, TimeUnit.SECONDS);

        // shutdown during processing
        context.stop();

        // should route all
        assertEquals("Should complete all messages", batch, counter.get());
    }

    @Override
    protected RouteBuilder createRouteBuilder() throws Exception {
        return new RouteBuilder() {
            @Override
            // START SNIPPET: e1
            public void configure() throws Exception {
                from(url).routeId("foo").noAutoStartup()
                    // let it complete all tasks during shutdown
                    .shutdownRunningTask(ShutdownRunningTask.CompleteAllTasks)
                    .process(new MyProcessor())
                    .to("mock:bar");
            }
            // END SNIPPET: e1
        };
    }

    public static class MyProcessor implements Processor {

        public void process(Exchange exchange) throws Exception {
            counter.incrementAndGet();
            latch.countDown();
        }
    }

}</code></pre></div></div></div><div class="sect3"><h4 id="GracefulShutdown-JMXmanaged"><a class="anchor" href="#GracefulShutdown-JMXmanaged"></a>JMX managed</h4><div class="paragraph"><p>The<code>ShutdownStrategy</code>is JMX aware as well so you can manage it from a JMX console. For example you can change the timeout value.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-Shuttingdownindividualroutes"><a class="anchor" href="#GracefulShutdown-Shuttingdownindividualroutes"></a>Shutting down individual routes</h4><div class="paragraph"><p><strong>Available as of Camel 2.3</strong>Its now possible to gracefully shutdown an individual route using<code>shutdownRoute(routeId)</code>method on<code>CamelContext</code>. Its also possible to provide a specific timeout to use instead of the default timeout settings using<code>shutdownRoute(routeId, timeout, timeUnit)</code>.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-Developerrelated"><a class="anchor" href="#GracefulShutdown-Developerrelated"></a>Developer related</h4><div class="paragraph"><p>If you develop your own Camel component or want to implement your own shutdown strategy then read this section for details.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-ShutdownStrategy"><a class="anchor" href="#GracefulShutdown-ShutdownStrategy"></a>ShutdownStrategy</h4><div class="paragraph"><p>You can implement your own strategy to control the shutdown by implementing the<code>org.apache.camel.spi.ShutdownStrategy</code>and the set it on the<code>CamelContext</code>using the<code>setShutdownStrategy</code>method.</p></div><div class="paragraph"><p>When using Spring XML you then just define a spring bean which implements the<code>org.apache.camel.spi.ShutdownStrategy</code>and Camel will look it up at startup and use it instead of its default. See more at<a href="advanced-configuration-of-camelcontext-using-spring.html">Advanced configuration of CamelContext using Spring</a>.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-ShutdownAware"><a class="anchor" href="#GracefulShutdown-ShutdownAware"></a>ShutdownAware</h4><div class="paragraph"><p>The interface<code>org.apache.camel.spi.ShutdownAware</code>is an optional interface consumers can implement to have fine grained control during shutdown. The<code>ShutdownStrategy</code>must be able to deal with consumers which implement this interface. This interface was introduced to cater for in memory consumers such as<a href="#seda-component">SEDA</a>which potentially have a number of pending messages on its internal in memory queues. What this allows is to let it control the shutdown process to let it complete its pending messages.</p></div><div class="paragraph"><p>The method<code>getPendingExchangesSize</code>should return the number of pending messages which reside on the in memory queues.<br>The method<code>deferShutdown</code>should return<code>true</code>to defer the shutdown to a later stage, when there are no more pending and inflight messages.</p></div><div class="paragraph"><p><a href="batch-consumer.html">Batch Consumer</a>should implement<code>ShutdownAware</code>so they properly support the<code>ShutdownRunningTask</code>option. See<code>GenericFileConsumer</code>for an example.</p></div></div><div class="sect3"><h4 id="GracefulShutdown-SeeAlso"><a class="anchor" href="#GracefulShutdown-SeeAlso"></a>See Also</h4><div class="ulist"><ul><li><p><a href="configuring-route-startup-ordering-and-autostartup.adoc">Configuring route startup ordering and autostartup</a></p></li><li><p><a href="advanced-configuration-of-camelcontext-using-spring.html">Advanced configuration of CamelContext using Spring</a></p></li><li><p><a href="user-guide.html">User Guide</a></p></li></ul></div></div></div></article></main></div><footer class="footer"><p>This page was built using the Antora default UI.</p><p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p></footer><script src="../../_/js/site.js"></script><script src="../../_/js/vendor/highlight.js"></script><script>hljs.initHighlighting()</script></body></html>