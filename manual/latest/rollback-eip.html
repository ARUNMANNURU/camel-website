<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Untitled :: Apache Camel</title><link rel="canonical" href="https://camel.apache.org/staging/manual/latest/rollback-eip.html"><meta name="generator" content="Antora 2.0.0"><link rel="stylesheet" href="../../_/css/site.css"></head><body class="article"><header class="header"><nav class="navbar shadow border-bottom"><div class="navbar-brand"><a class="navbar-item nav-logo" href="../.." title="Apache Camel"></a><button class="navbar-burger" data-target="topbar-nav"><span></span><span></span><span></span></button></div><div id="topbar-nav" class="navbar-menu"><div class="navbar-end"><a class="navbar-item" href="../../">Home</a><a class="navbar-item" href="../../news/">News</a><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="../..#">Projects</a><div class="navbar-dropdown"><a class="navbar-item" href="../../projects/camel-k/">Camel K</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="../..#">Documentation</a><div class="navbar-dropdown"><a class="navbar-item" href="../../docs/getting-started/">Getting started</a><a class="navbar-item" href="../../manual/latest/">User manual</a><a class="navbar-item" href="../../components/latest/">Component reference</a><a class="navbar-item" href="../../camel-k/latest/">Camel K</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="../..#">Community</a><div class="navbar-dropdown"><a class="navbar-item" href="../../community/support/">Support</a><a class="navbar-item" href="../..https://github.com/apache/camel/blob/master/CONTRIBUTING.md">Contributing</a><a class="navbar-item" href="../../community/user-stories/">User stories</a><a class="navbar-item" href="../../community/articles/">Articles</a><a class="navbar-item" href="../../community/books/">Books</a><a class="navbar-item" href="../../community/team/">Team</a><a class="navbar-item" href="../../community/camel-extra/">Camel extra</a></div></div><a class="navbar-item" href="../../download/">Download</a><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="../..#">About</a><div class="navbar-dropdown"><a class="navbar-item" href="../..https://www.apache.org/events/current-event.html">Apache events</a><a class="navbar-item" href="../..https://www.apache.org/licenses/">License</a><a class="navbar-item" href="../../security/">Security</a><a class="navbar-item" href="../..https://www.apache.org/foundation/sponsorship.html">Sponsorship</a><a class="navbar-item" href="../..https://www.apache.org/foundation/thanks.html">Thanks</a></div></div></div></div></nav></header><div class="main-wrapper"><div class="navigation-container" data-component="manual" data-version="latest"><aside class="navigation"><div class="panels"><div class="navigation-menu is-active" data-panel="menu"><nav class="nav-menu"><h3 class="title"><a href="index.html">User manual</a></h3><ul class="nav-list"><li class="nav-item" data-depth="0"><ul class="nav-list"><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="getting-started.html">Getting started</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="book-getting-started.html">Getting Started with Apache Camel</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="architecture.html">Architecture</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="async.html">Async</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="asynchronous-routing-engine.html">Asynchronous Routing Engine</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="backlogdebugger.html">Backlog debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bam.html">Business Activity Monitoring</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="batch-consumer.html">Batch Consumer</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="browsable-endpoint.html">BrowsableEndpoint</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camel-core.html">Core</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camelcontext.html">Context</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="endpoint.html">Endpoints</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="cep.html">Complex Event Processing</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="component.html">Component</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="debugger.html">Debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="delay-interceptor.html">Delay interceptor</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dependency-injection.html">Dependency Injection</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dozer-type-conversion.html">Dozer Type Conversion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bean-integration.html">Bean Integration</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="error-handler.html">Error Handler</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange.html">Message Exchange</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange-pattern.html">Exchange Pattern</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="expression.html">Expressions</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="injector.html">Injector</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="intercept.html">Intercept</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="inversion-of-control-with-smart-defaults.html">Inversion Of Control With Smart Defaults</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="jmx.html">JMX</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="lifecycle.html">Camel Lifecycle</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="oncompletion.html">OnCompletion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="predicate.html">Predicates</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="registry.html">Registry</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="route-builder.html">RouteBuilder</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="routes.html">Routes</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="transformer.html">Transformer</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="validator.html">Validator</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><span class="nav-text">Domain Specific Languages</span><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="dsl.html">Camel Domain Specific Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="java-dsl.html">Java DSL</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="spring.html">Spring support</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="groovy-dsl.html">Groovy DSL</a></li></ul></li><li class="nav-item" data-depth="1"><a class="nav-link" href="using-osgi-blueprint-with-camel.html">Using OSGi blueprint with Camel</a></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><span class="nav-text">Supported expression languages</span><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="constant-language.html">Constant Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchangeProperty-language.html">ExchangeProperty Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="file-language.html">File Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="header-language.html">Header Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="ref-language.html">Ref Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="simple-language.html">Simple Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="tokenize-language.html">Tokenize Language</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="enterprise-integration-patterns.html">Enterprise Integration Patterns</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="aggregate-eip.html">Aggregate EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="batch-config-eip.html">Batch-config EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bean-eip.html">Bean EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="choice-eip.html">Choice EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="circuitBreaker-eip.html">Circuit Breaker EIP (deprecated)</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="claimCheck-eip.html">Claim Check EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="content-based-router-eip.html">Content Based Router</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="content-filter-eip.html">Content Filter</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="convertBodyTo-eip.html">Convert Body To EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="customLoadBalancer-eip.html">Custom Load Balancer EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="delay-eip.html">Delay EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dynamic-router.html">Dynamic Router</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dynamicRouter-eip.html">Dynamic Router EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="enrich-eip.html">Enrich EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="eventDrivenConsumer-eip.html">Event Driven Consumer</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="failover-eip.html">Failover EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="filter-eip.html">Filter EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="from-eip.html">From EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="hystrix-eip.html">Hystrix EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="hystrixConfiguration-eip.html">Hystrix Configuration EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="idempotentConsumer-eip.html">Idempotent Consumer EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="inOnly-eip.html">In Only EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="inOut-eip.html">In Out EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="loadBalance-eip.html">Load Balance EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="log-eip.html">Log EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="loop-eip.html">Loop EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="marshal-eip.html">Marshal EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="multicast-eip.html">Multicast EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="onFallback-eip.html">On Fallback EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="otherwise-eip.html">Otherwise EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="pipeline-eip.html">Pipeline EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="pollEnrich-eip.html">Poll Enrich EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="process-eip.html">Process EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="random-eip.html">Random EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="recipientList-eip.html">Recipient List EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="removeHeader-eip.html">Remove Header EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="removeHeaders-eip.html">Remove Headers EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="removeProperties-eip.html">Remove Properties EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="removeProperty-eip.html">Remove Property EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="requestReply-eip.html">Request Reply</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="resequence-eip.html">Resequence EIP</a></li><li class="nav-item is-current-page" data-depth="2"><a class="nav-link" href="rollback-eip.html">Rollback EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="roundRobin-eip.html">Round Robin EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="routingSlip-eip.html">Routing Slip EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="saga-eip.html">Saga EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="sample-eip.html">Sample EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="script-eip.html">Script EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="serviceCall-eip.html">Service Call EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="setBody-eip.html">Set Body EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="setFaultBody-eip.html">Set Fault Body EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="setHeader-eip.html">Set Header EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="setOutHeader-eip.html">Set Out Header EIP (deprecated)</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="setProperty-eip.html">Set Property EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="sort-eip.html">Sort EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="split-eip.html">Split EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="step-eip.html">Step EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="sticky-eip.html">Sticky EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="stop-eip.html">Stop EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="stream-config-eip.html">Stream-config EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="threads-eip.html">Threads EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="throttle-eip.html">Throttle EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="to-eip.html">To EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="toD-eip.html">To D EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="topic-eip.html">Topic EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="transform-eip.html">Transform EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="unmarshal-eip.html">Unmarshal EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="validate-eip.html">Validate EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="weighted-eip.html">Weighted EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="when-eip.html">When EIP</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="wireTap-eip.html">Wire Tap EIP</a></li></ul></li></ul></li></ul></nav></div><div class="navigation-explore" data-panel="explore"><div class="context"><span class="title">User manual</span><span class="version">latest</span></div><ul class="components"><li class="component"><span class="title">Apache Camel K</span><ul class="versions"><li class="version is-latest"><a href="../../camel-k/latest/index.html">latest</a></li></ul></li><li class="component"><span class="title">Component reference</span><ul class="versions"><li class="version is-latest"><a href="../../components/latest/index.html">latest</a></li></ul></li><li class="component is-current"><span class="title">User manual</span><ul class="versions"><li class="version is-current is-latest"><a href="index.html">latest</a></li></ul></li></ul></div></div></aside></div><main class="main"><div class="toolbar" role="navigation"><button class="navigation-toggle"></button><a href="index.html" class="home-link"></a><nav class="crumbs" aria-label="breadcrumbs"><ul><li class="crumb"><a href="index.html">User manual</a></li><li class="crumb"><a href="enterprise-integration-patterns.html">Enterprise Integration Patterns</a></li><li class="crumb"><a href="rollback-eip.html">Rollback EIP</a></li></ul></nav><div class="edit-this-page"><a href="https://github.com/apache/camel/edit/master/docs/user-manual/modules/ROOT/pages/rollback-eip.adoc">Edit this Page</a></div></div><article class="doc"><div class="sect1"><h2 id="rollback-eip"><a class="anchor" href="#rollback-eip"></a>Rollback EIP</h2><div class="sectionbody"><div class="paragraph"><p>Rollback might be needed if there is a transaction or transactional pieces in your design.</p></div><div class="paragraph"><p>Camel recommends supporting the<a href="http://www.enterpriseintegrationpatterns.com/TransactionalClient.html">Transactional Client</a>from the<a href="enterprise-integration-patterns.html">EIP patterns</a>using spring transactions.</p></div><div class="paragraph"><p><span class="image"><img src="http://www.enterpriseintegrationpatterns.com/img/TransactionalClientSolution.gif" alt="image"></span></p></div><div class="paragraph"><p>Transaction Oriented Endpoints like<a href="https://github.com/apache/camel/blob/master/components/camel-jms/src/main/docs/jms-component.adoc">JMS</a>support using a transaction for both inbound and outbound message exchanges. Endpoints that support transactions will participate in the current transaction context that they are called from.</p></div><div class="paragraph"><p>Configuration of Redelivery</p></div><div class="paragraph"><p>The redelivery in transacted mode is<strong>not</strong>handled by Camel but by the backing system (the transaction manager). In such cases you should resort to the backing system how to configure the redelivery.</p></div><div class="paragraph"><p>You should use the<a href="http://camel.apache.org/maven/current/camel-spring/apidocs/org/apache/camel/spring/SpringRouteBuilder.html">SpringRouteBuilder</a>to setup the routes since you will need to setup the spring context with the TransactionTemplates that will define the transaction manager configuration and policies.</p></div><div class="paragraph"><p>For inbound endpoint to be transacted, they normally need to be configured to use a Spring PlatformTransactionManager. In the case of the JMS component, this can be done by looking it up in the spring context.</p></div><div class="paragraph"><p>You first define needed object in the spring configuration.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="jmsTransactionManager" class="org.springframework.jms.connection.JmsTransactionManager"&gt;
  &lt;property name="connectionFactory" ref="jmsConnectionFactory" /&gt;
&lt;/bean&gt;
&lt;bean id="jmsConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;
  &lt;property name="brokerURL" value="tcp://localhost:61616"/&gt;
&lt;/bean&gt;</code></pre></div></div><div class="paragraph"><p>Then you look them up and use them to create the JmsComponent.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PlatformTransactionManager transactionManager = (PlatformTransactionManager) spring.getBean("jmsTransactionManager");
ConnectionFactory connectionFactory = (ConnectionFactory) spring.getBean("jmsConnectionFactory");
JmsComponent component = JmsComponent.jmsComponentTransacted(connectionFactory, transactionManager);
component.getConfiguration().setConcurrentConsumers(1);
ctx.addComponent("activemq", component);</code></pre></div></div><div class="sect2"><h3 id="_options"><a class="anchor" href="#_options"></a>Options</h3><div class="paragraph"><p>The Rollback EIP supports 3 options which are listed below:</p></div><table class="tableblock frame-all grid-all stretch"><colgroup><col style="width: 20%;"><col style="width: 50%;"><col style="width: 10%;"><col style="width: 20%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Name</th><th class="tableblock halign-left valign-top">Description</th><th class="tableblock halign-center valign-top">Default</th><th class="tableblock halign-left valign-top">Type</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>markRollbackOnly</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Mark the transaction for rollback only (cannot be overruled to commit)</p></td><td class="tableblock halign-center valign-top"><p class="tableblock">false</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>markRollbackOnlyLast</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Mark only last sub transaction for rollback only. When using sub transactions (if the transaction manager support this)</p></td><td class="tableblock halign-center valign-top"><p class="tableblock">false</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>message</strong></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Message to use in rollback exception</p></td><td class="tableblock halign-center valign-top"></td><td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td></tr></tbody></table><div class="sect3"><h4 id="_transaction_policies"><a class="anchor" href="#_transaction_policies"></a>Transaction Policies</h4><div class="paragraph"><p>Outbound endpoints will automatically enlist in the current transaction context. But what if you do not want your outbound endpoint to enlist in the same transaction as your inbound endpoint? The solution is to add a Transaction Policy to the processing route. You first have to define transaction policies that you will be using. The policies use a spring TransactionTemplate under the covers for declaring the transaction demarcation to use. So you will need to add something like the following to your spring xml:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="PROPAGATION_REQUIRED" class="org.apache.camel.spring.spi.SpringTransactionPolicy"&gt;
  &lt;property name="transactionManager" ref="jmsTransactionManager"/&gt;
&lt;/bean&gt;
&lt;bean id="PROPAGATION_REQUIRES_NEW" class="org.apache.camel.spring.spi.SpringTransactionPolicy"&gt;
  &lt;property name="transactionManager" ref="jmsTransactionManager"/&gt;
  &lt;property name="propagationBehaviorName" value="PROPAGATION_REQUIRES_NEW"/&gt;
&lt;/bean&gt;</code></pre></div></div><div class="paragraph"><p>Then in your<a href="http://camel.apache.org/maven/current/camel-spring/apidocs/org/apache/camel/spring/SpringRouteBuilder.html">SpringRouteBuilder</a>, you just need to create new SpringTransactionPolicy objects for each of the templates.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void configure() {
    ...
    Policy required = bean(SpringTransactionPolicy.class, "PROPAGATION_REQUIRED"));
    Policy requirenew = bean(SpringTransactionPolicy.class, "PROPAGATION_REQUIRES_NEW"));
    ...
}</code></pre></div></div><div class="paragraph"><p>Once created, you can use the Policy objects in your processing routes:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"> // Send to bar in a new transaction
from("activemq:queue:foo").policy(requirenew).to("activemq:queue:bar");
// Send to bar without a transaction.
from("activemq:queue:foo").policy(notsupported).to("activemq:queue:bar");</code></pre></div></div></div><div class="sect3"><h4 id="_osgi_blueprint"><a class="anchor" href="#_osgi_blueprint"></a>OSGi Blueprint</h4><div class="paragraph"><p>If you are using<a href="https://github.com/apache/camel/blob/master/docs/user-manual/en/using-osgi-blueprint-with-camel.adoc">OSGi Blueprint</a>then you most likely have to explicit declare a policy and refer to the policy from the transacted in the route.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;bean id="required" class="org.apache.camel.spring.spi.SpringTransactionPolicy"&gt;
  &lt;property name="transactionManager" ref="jmsTransactionManager"/&gt;
  &lt;property name="propagationBehaviorName" value="PROPAGATION_REQUIRED"/&gt;
&lt;/bean&gt;</code></pre></div></div><div class="paragraph"><p>And then refer to "required" from the route:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;route&gt;
  &lt;from uri="activemq:queue:foo"/&gt;
  &lt;transacted ref="required"/&gt;
  &lt;to uri="activemq:queue:bar"/&gt;
&lt;/route&gt;</code></pre></div></div></div></div><div class="sect2"><h3 id="_database_sample"><a class="anchor" href="#_database_sample"></a>Database Sample</h3><div class="paragraph"><p>In this sample we want to ensure that two endpoints is under transaction control. These two endpoints inserts data into a database.<br>The sample is in its full as a<a href="https://github.com/apache/camel/blob/master/components/camel-spring/src/test/java/org/apache/camel/spring/interceptor/TransactionalClientDataSourceMinimalConfigurationTest.java">unit test</a>.</p></div><div class="paragraph"><p>First of all we setup the usual spring stuff in its configuration file. Here we have defined a DataSource to the HSQLDB and a most importantly the Spring DataSource TransactionManager that is doing the heavy lifting of ensuring our transactional policies. You are of course free to use any of the Spring based TransactionManager, eg. if you are in a full blown J2EE container you could use JTA or the WebLogic or WebSphere specific managers.</p></div><div class="paragraph"><p>As we use the new convention over configuration we do<strong>not</strong>need to configure a transaction policy bean, so we do not have any<code>PROPAGATION_REQUIRED</code>beans. All the beans needed to be configured is<strong>standard</strong>Spring beans only, eg. there are no Camel specific configuration at all.<a href="https://github.com/apache/camel/blob/master/components/camel-spring/src/test/resources/org/apache/camel/spring/interceptor/springTransactionalClientDataSourceMinimalConfiguration.xml">springTransactionalClientDataSourceMinimalConfiguration</a>Then we are ready to define our Camel routes. We have two routes: 1 for success conditions, and 1 for a forced rollback condition.<br>This is after all based on a unit test. Notice that we mark each route as transacted using the<strong>transacted</strong>tag.<a href="https://github.com/apache/camel/blob/master/components/camel-spring/src/test/resources/org/apache/camel/spring/interceptor/springTransactionalClientDataSourceMinimalConfiguration.xml">springTransactionalClientDataSourceMinimalConfiguration</a>That is all that is needed to configure a Camel route as being transacted. Just remember to use the<strong>transacted</strong>DSL. The rest is standard Spring XML to setup the transaction manager.</p></div></div><div class="sect2"><h3 id="_jms_sample"><a class="anchor" href="#_jms_sample"></a>JMS Sample</h3><div class="paragraph"><p>In this sample we want to listen for messages on a queue and process the messages with our business logic java code and send them along. Since its based on a<a href="https://github.com/apache/camel/blob/master/components/camel-jms/src/test/java/org/apache/camel/component/jms/tx/TransactionMinimalConfigurationTest.java">TransactionMinimalConfigurationTest.java</a>the destination is a mock endpoint.</p></div><div class="paragraph"><p>First we configure the standard Spring XML to declare a JMS connection factory, a JMS transaction manager and our ActiveMQ component that we use in our routing.<a href="https://github.com/apache/camel/blob/master/components/camel-jms/src/test/resources/org/apache/camel/component/jms/tx/TransactionMinimalConfigurationTest.xml">TransactionMinimalConfigurationTest.xml</a>And then we configure our routes. Notice that all we have to do is mark the route as transacted using the<strong>transacted</strong>tag.<a href="https://github.com/apache/camel/blob/master/components/camel-jms/src/test/resources/org/apache/camel/component/jms/tx/TransactionMinimalConfigurationTest.xml">TransactionMinimalConfigurationTest.xml</a></p></div><div class="paragraph"><p>Transaction error handler</p></div><div class="paragraph"><p>When a route is marked as transacted using<strong>transacted</strong>Camel will automatic use the<a href="transactionerrorhandler.html">TransactionErrorHandler</a>as<a href="https://github.com/apache/camel/blob/master/docs/user-manual/en/error-handler.adoc">Error Handler</a>. It supports basically the same feature set as the<a href="defaulterrorhandler.html">DefaultErrorHandler</a>, so you can for instance use<a href="exception-clause.html">Exception Clause</a>as well.</p></div></div><div class="sect2"><h3 id="_integration_testing_with_spring"><a class="anchor" href="#_integration_testing_with_spring"></a>Integration Testing with Spring</h3><div class="paragraph"><p>An Integration Test here means a test runner class annotated<code>@RunWith(SpringJUnit4ClassRunner.class).</code></p></div><div class="paragraph"><p>When following the Spring Transactions documentation it is tempting to annotate your integration test with <code>@Transactional</code>then seed your database before firing up the route to be tested and sending a message in. This is incorrect as Spring will have an in-progress transaction, and Camel will wait on this before proceeding, leading to the route timing out.</p></div><div class="paragraph"><p>Instead, remove the<code>@Transactional</code>annotation from the test method and seed the test data within a <code>TransactionTemplate</code>execution which will ensure the data is committed to the database before Camel attempts to pick up and use the transaction manager. A simple example https://github.com/rajivj2/example2/blob/master/src/test/java/com/example/NotificationRouterIT.java[can be found on GitHub].</p></div><div class="paragraph"><p>Spring&#8217;s transactional model ensures each transaction is bound to one thread. A Camel route may invoke additional threads which is where the blockage may occur. This is not a fault of Camel but as the programmer you must be aware of the consequences of beginning a transaction in a test thread and expecting a separate thread created by your Camel route to be participate, which it cannot. You can, in your test, mock the parts that cause separate threads to avoid this issue.</p></div></div><div class="sect2"><h3 id="_using_multiple_routes_with_different_propagation_behaviors"><a class="anchor" href="#_using_multiple_routes_with_different_propagation_behaviors"></a>Using multiple routes with different propagation behaviors</h3><div class="paragraph"><p><strong>Available as of Camel 2.2</strong><br>Suppose you want to route a message through two routes and by which the 2nd route should run in its own transaction. How do you do that? You use propagation behaviors for that where you configure it as follows:</p></div><div class="ulist"><ul><li><p>The first route use<code>PROPAGATION_REQUIRED</code></p></li><li><p>The second route use<code>PROPAGATION_REQUIRES_NEW</code></p></li></ul></div><div class="paragraph"><p>This is configured in the Spring XML file.<a href="https://github.com/apache/camel/blob/master/components/camel-spring/src/test/resources/org/apache/camel/spring/interceptor/MixedTransactionPropagationTest.xml">MixedTransactionPropagationTest.xml</a>Then in the routes you use transacted DSL to indicate which of these two propagations it uses.<a href="https://github.com/apache/camel/blob/master/components/camel-spring/src/test/java/org/apache/camel/spring/interceptor/MixedTransactionPropagationTest.java">MixedTransactionPropagationTest.java</a>Notice how we have configured the<code>onException</code>in the 2nd route to indicate in case of any exceptions we should handle it and just rollback this transaction. This is done using the<code>markRollbackOnlyLast</code>which tells Camel to only do it for the current transaction and not globally.</p></div><div class="sect3"><h4 id="_see_also"><a class="anchor" href="#_see_also"></a>See Also</h4><div class="ulist"><ul><li><p><a href="error-handling-in-camel.html">Error handling in Camel</a></p></li><li><p><a href="transactionerrorhandler.html">TransactionErrorHandler</a></p></li><li><p><a href="https://github.com/apache/camel/blob/master/docs/user-manual/en/error-handler.adoc">Error Handler</a></p></li><li><p><a href="https://github.com/apache/camel/blob/master/components/camel-jms/src/main/docs/jms-component.adoc">JMS</a></p></li><li><p><a href="https://github.com/apache/camel/blob/master/docs/user-manual/en/oncompletion.adoc">On Completion</a></p></li></ul></div><div class="paragraph"><p><a href="using-this-pattern.html">Using This Pattern</a></p></div></div></div></div></div></article></main></div><footer class="footer"><p>This page was built using the Antora default UI.</p><p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p></footer><script src="../../_/js/site.js"></script><script src="../../_/js/vendor/highlight.js"></script><script>hljs.initHighlighting()</script></body></html>