<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Untitled :: Apache Camel</title><link rel="canonical" href="https://camel.apache.org/manual/latest/threading-model.html"><meta name="generator" content="Antora 2.0.0-rc.2"><link rel="stylesheet" href="../../_/css/site.css"></head><body class="article"><header class="header"><nav class="navbar"><div class="navbar-brand"><a class="navbar-item" href="https://camel.apache.org">Apache Camel</a><button class="navbar-burger" data-target="topbar-nav"><span></span><span></span><span></span></button></div><div id="topbar-nav" class="navbar-menu"><div class="navbar-end"><a class="navbar-item" href="#">Home</a><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Products</a><div class="navbar-dropdown"><a class="navbar-item" href="#">Product A</a><a class="navbar-item" href="#">Product B</a><a class="navbar-item" href="#">Product C</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Services</a><div class="navbar-dropdown"><a class="navbar-item" href="#">Service A</a><a class="navbar-item" href="#">Service B</a><a class="navbar-item" href="#">Service C</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Resources</a><div class="navbar-dropdown"><a class="navbar-item" href="#">Resource A</a><a class="navbar-item" href="#">Resource B</a><a class="navbar-item" href="#">Resource C</a></div></div><div class="navbar-item"><span class="control"><a class="button is-primary" href="#">Download</a></span></div></div></div></nav></header><div class="main-wrapper"><div class="navigation-container" data-component="manual" data-version="latest"><aside class="navigation"><div class="panels"><div class="navigation-menu is-active" data-panel="menu"><nav class="nav-menu"><h3 class="title"><a href="index.html">User manual</a></h3><ul class="nav-list"><li class="nav-item" data-depth="0"><ul class="nav-list"><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="getting-started.html">Getting started</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="book-getting-started.html">Getting Started with Apache Camel</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="architecture.html">Architecture</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="async.html">Async</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="asynchronous-routing-engine.html">Asynchronous Routing Engine</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="backlogdebugger.html">Backlog debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bam.html">Business Activity Monitoring</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="batch-consumer.html">Batch Consumer</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="browsable-endpoint.html">BrowsableEndpoint</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camel-core.html">Core</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camelcontext.html">Context</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="endpoint.html">Endpoints</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="cep.html">Complex Event Processing</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="component.html">Component</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="debugger.html">Debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="delay-interceptor.html">Delay interceptor</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dependency-injection.html">Dependency Injection</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dozer-type-conversion.html">Dozer Type Conversion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bean-integration.html">Bean Integration</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="error-handler.html">Error Handler</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange.html">Message Exchange</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange-pattern.html">Exchange Pattern</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="expression.html">Expressions</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="injector.html">Injector</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="intercept.html">Intercept</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="inversion-of-control-with-smart-defaults.html">Inversion Of Control With Smart Defaults</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="lifecycle.html">Camel Lifecycle</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="oncompletion.html">OnCompletion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="predicate.html">Predicates</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="registry.html">Registry</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="route-builder.html">RouteBuilder</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="routes.html">Routes</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><span class="nav-text">Domain Specific Languages</span><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="dsl.html">Camel Domain Specific Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="java-dsl.html">Java DSL</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="spring.html">Spring support</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="groovy-dsl.html">Groovy DSL</a></li><li class="nav-item" data-depth="2"><button class="nav-toggle"></button><span class="nav-text">Scala DSL</span><ul class="nav-list"><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl.html">About the Scala DSL</a></li><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl-getting-started.html">Getting Started</a></li><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl-eip.html">EIP</a></li><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl-supported-languages.html">Supported languages</a></li></ul></li></ul></li><li class="nav-item" data-depth="1"><a class="nav-link" href="using-osgi-blueprint-with-camel.html">Using OSGi blueprint with Camel</a></li></ul></li></ul></nav></div><div class="navigation-explore" data-panel="explore"><div class="context"><span class="title">User manual</span><span class="version">latest</span></div><ul class="components"><li class="component"><span class="title">Apache Camel K</span><ul class="versions"><li class="version is-latest"><a href="../../camel-k/latest/index.html">latest</a></li></ul></li><li class="component"><span class="title">Component reference</span><ul class="versions"><li class="version is-latest"><a href="../../components/latest/index.html">latest</a></li></ul></li><li class="component is-current"><span class="title">User manual</span><ul class="versions"><li class="version is-current is-latest"><a href="index.html">latest</a></li></ul></li></ul></div></div></aside></div><main class="main"><div class="toolbar" role="navigation"><button class="navigation-toggle"></button><a href="index.html" class="home-link"></a><nav class="crumbs" aria-label="breadcrumbs"></nav></div><article class="doc"><div class="sect2"><h3 id="ThreadingModel-ThreadingModel"><a class="anchor" href="#ThreadingModel-ThreadingModel"></a>Threading Model</h3><div class="paragraph"><p><strong>Available as of Camel 2.3</strong></p></div><div class="paragraph"><p>The threading model in Camel is based on leveraging the JDK concurrency API which provides thread pools, named<code>ExecutorService</code>.</p></div><div class="paragraph"><p>Camel leverages thread pools in the following places:</p></div><div class="ulist"><ul><li><p>several<a href="eip.html">EIP</a>patterns supports using thread pools for concurrency</p></li><li><p><a href="seda.html">SEDA</a>component for asynchronous connectivity</p></li><li><p><a href="async.html">Threads DSL</a>in the Camel route</p></li><li><p><a href="servicepool.html">ServicePool</a>for pooling services</p></li><li><p>And some component provide thread pools by nature such as<a href="jms.html">JMS</a>,<a href="jetty.html">Jetty</a></p></li></ul></div><div class="sect3"><h4 id="ThreadingModel-Threadpoolprofiles"><a class="anchor" href="#ThreadingModel-Threadpoolprofiles"></a>Thread pool profiles</h4><div class="paragraph"><p>By default when a thread pool is to be created then its based on the default thread pool profile which is:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    &lt;threadPoolProfile id="defaultThreadPoolProfile" defaultProfile="true"
                       poolSize="10" maxPoolSize="20" maxQueueSize="1000" allowCoreThreadTimeOut="false"
                       rejectedPolicy="CallerRuns"/&gt;</code></pre></div></div><div class="paragraph"><p>What that means is that for example when you use<a href="multicast.html">Multicast</a>with<code>parallelProcessing=true</code>enabled, then it would create a thread pool based on the profile above. The<code>rejectedPolicy</code>has four options:<code>Abort, CallerRuns, Discard, DiscardOldest</code>which corresponds to the same four options provided out of the box in the JDK.<strong>Notice:</strong> option allowCoreThreadTimeOut is a new option from<strong>Camel 2.15</strong>onwards.</p></div><div class="paragraph"><p>You can define as many thread pool profiles as you like. But there must only<strong>one</strong>default profile. A custom thread pool profile will inherit from the default profile. Which means that any option you do not explicit define will fallback and use the option from the default profile.</p></div><div class="paragraph"><p>You can use<code>-1</code>in maxQueueSize to indicate a unbounded queue.</p></div><div class="paragraph"><p>In Java DSL you can configure the default thread pool profile from the<code>ExecutorServiceStrategy</code>/<code>ExecutorServiceManager</code>which you access from<code>CamelContext</code>.</p></div></div><div class="sect3"><h4 id="ThreadingModel-Usingthreadpoolprofiles"><a class="anchor" href="#ThreadingModel-Usingthreadpoolprofiles"></a>Using thread pool profiles</h4><div class="paragraph"><p>Suppose you want to use a custom thread pool profile for a Multicast EIP pattern in a Camel route you can do it using the<code>executorServiceRef</code>attribute as shown:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">&lt;camelContext ...&gt;
    ...
    &lt;threadPoolProfile id="fooProfile"
                       poolSize="20" maxPoolSize="50" maxQueueSize="-1"/&gt;
    ...

    &lt;route&gt;
       ...
       &lt;multicast strategyRef="myStrategy" executorServiceRef="fooProfile"&gt;
          ...
       &lt;/multicast&gt;
      ...
    &lt;route&gt;
&lt;/camelContext&gt;</code></pre></div></div><div class="paragraph"><p>What Camel will do at runtime is to lookup in the<a href="registry.html">Registry</a>for a<code>ExecutorService</code>with the id = fooProfile. If none found it will fallback and see if there is a<code>ThreadPoolProfile</code>defined with that id. And in this example there is and so the profile is used for creating a new<code>ExecutorService</code>which is handed back to the<a href="multicast.html">Multicast</a>EIP to use in the route.</p></div></div><div class="sect3"><h4 id="ThreadingModel-Createcustomthreadpool"><a class="anchor" href="#ThreadingModel-Createcustomthreadpool"></a>Create custom thread pool</h4><div class="paragraph"><p>You can also use the &lt;threadPool/&gt; tag in Spring XML to create a specific thread pool (eg<code>ExecutorService</code>). Notice that any options you do not explicit define, will have Camel to use the default thread pool profile as fallback. For example if you omit setting the<code>maxQueueSize</code>then Camel will fallback and use the value from the default thread pool profiles, which by default is 1000.</p></div></div><div class="sect3"><h4 id="ThreadingModel-Management"><a class="anchor" href="#ThreadingModel-Management"></a>Management</h4><div class="paragraph"><p>All the thread pools that Camel creates are managed and thus you can see them in JConsole under the<code>threadpools</code>category.</p></div></div><div class="sect3"><h4 id="ThreadingModel-ExecutorServiceStrategy"><a class="anchor" href="#ThreadingModel-ExecutorServiceStrategy"></a>ExecutorServiceStrategy</h4><div class="paragraph"><p><strong>Available as of Camel 2.3 to 2.8.x</strong><br>Camel provides a pluggable strategy to hook in your own thread pool provider, for example from a WorkManager in a J2EE server etc.<br>See the<code>org.apache.camel.spi.ExecutorServiceStrategy</code>interface which you should implement and hook into the WorkManager.</p></div><div class="paragraph"><p>See<a href="advanced-configuration-of-camelcontext-using-spring.html">Advanced configuration of CamelContext using Spring</a>for how to configure it.</p></div><div class="paragraph"><p>You can configure it on the<code>CamelContext</code>from Java DSL using the getter/setter.</p></div></div><div class="sect3"><h4 id="ThreadingModel-ExecutorServiceManager"><a class="anchor" href="#ThreadingModel-ExecutorServiceManager"></a>ExecutorServiceManager</h4><div class="paragraph"><p><strong>Available as of Camel 2.9</strong></p></div><div class="paragraph"><p>In camel 2.9.0 the<code>ExecutorServiceManager</code>replaces the<code>ExecutorServiceStrategy</code>. It is renamed to manager as is not only provides a strategy for thread pool creation but also keeps track of thread pools and thread pool profiles.</p></div><div class="paragraph"><p>To hook in custom thread pool providers (e.g. for J2EE servers) a<code>ThreadPoolFactory</code>interface can be implemented. The implementation can be set in the<code>ExecutorServiceManager</code>. The Factory interface is much simpler then the former<code>ExecutorServiceStrategy</code>and makes the job of integrators much easier.</p></div><div class="paragraph"><p>See<a href="advanced-configuration-of-camelcontext-using-spring.html">Advanced configuration of CamelContext using Spring</a>for how to configure it.</p></div></div><div class="sect3"><h4 id="ThreadingModel-Customizingthreadnames"><a class="anchor" href="#ThreadingModel-Customizingthreadnames"></a>Customizing thread names</h4><div class="paragraph"><p>On the<code>ExecutorServiceStrategy</code>/<code>ExecutorServiceManager</code>you can configure the thread name pattern using the<code>setThreadNamePattern</code>method, which defines the thread names used when a thread pool creates a thread.</p></div><div class="paragraph"><p>The default pattern is for:</p></div><div class="ulist"><ul><li><p><strong>Camel 2.9.x or older:</strong><code>Camel (${camelId}) thread #${counter} - ${name</code>}</p></li><li><p><strong>Camel 2.10 onwards:</strong><code>Camel (<mark>camelId</mark>) thread<mark>#counter</mark>-<mark>name</mark></code></p></li></ul></div><div class="paragraph"><p>Notice we renamed the tokens from Camel 2.10 onwards to not clash with tokens by the<a href="using-propertyplaceholder.html">Property Placeholder</a>.</p></div><div class="paragraph"><p>In the pattern you can use the following placeholders</p></div><div class="ulist"><ul><li><p>${camelId}<strong>Camel 2.6:</strong>is the<a href="camelcontext.html">CamelContext</a>name</p></li><li><p>${counter} is a unique incrementing counter.</p></li><li><p>${name} is the regular thread name.</p></li><li><p>${longName} is the long thread name which can includes endpoint parameters etc.</p></li></ul></div><div class="paragraph"><p>Notice the pattern name has changed from Camel 2.10 onwards, use<mark>name</mark>instead.</p></div><div class="paragraph"><p>In Camel 2.11 onwards its easier to set the thread name pattern on the CamelContext using the threadNamePattern attribute in the XML files as shown below:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">  &lt;camelContext xmlns="http://camel.apache.org/schema/spring" threadNamePattern="Riding the thread #counter#"&gt;
    &lt;route&gt;
      &lt;from uri="seda:start"/&gt;
      &lt;to uri="log:result"/&gt;
      &lt;to uri="mock:result"/&gt;
    &lt;/route&gt;
  &lt;/camelContext&gt;</code></pre></div></div></div><div class="sect3"><h4 id="ThreadingModel-Componentdevelopers"><a class="anchor" href="#ThreadingModel-Componentdevelopers"></a>Component developers</h4><div class="paragraph"><p>If you develop your own Camel component and are in need of a thread pool, then its advised to use the<code>ExecutorServiceStrategy</code>/<code>ExecutorServiceManager</code>to create the thread pool you need.</p></div></div><div class="sect3"><h4 id="ThreadingModel-Shutdown"><a class="anchor" href="#ThreadingModel-Shutdown"></a>Shutdown</h4><div class="paragraph"><p>All thread pools created by Camel will be properly shutdown when<code>CamelContext</code>shutdowns which ensures no leaks in the pools in case you run in a server environment with hot deployments and the likes.</p></div><div class="paragraph"><p>The<code>ExecutorServiceManager</code>has APIs for shutting down thread pools graceful and aggressively. Its encourage to use this API for creating and shutting down thread pools.</p></div><div class="paragraph"><p>From<strong>Camel 2.11</strong>onwards Camel the graceful<code>shutdownGraceful(executorService)</code>method from<code>ExecutorServiceManager</code>will shutdown graceful at first, until a timeout value is hit. After that it shutdown aggressively, again using the timeout value to wait for the operation to complete. This means you can wait at most 2 x timeout for shutting down the thread pool.<br>The timeout value is by default<code>10000</code>millis. You can configure a custom value on the<code>ExecutorServiceManager</code>if needed. During shutdown Camel will log every 2nd second at INFO level progress of shutting down the thread pool. For example in case a shutdown takes a while, then there is activity in the logs.</p></div><div class="paragraph"><p>The APIs on<code>ExecutorServiceManager</code>that is related to shutting down a thread pool is as follows:</p></div><table class="tableblock frame-all grid-all stretch"><colgroup><col style="width: 25%;"><col style="width: 75%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Method</th><th class="tableblock halign-left valign-top">Description</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">shutdown</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Marks the thread pool as shutdown, eg just as calling<code>ExecutorService.shutdown()</code>method</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">shutdownNow</p></td><td class="tableblock halign-left valign-top"><p class="tableblock">Forces the thread pool to shutdown now, eg just as calling<code>ExecutorService.shutdownNow()</code>method</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">shutdownGraceful</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Camel 2.11:</strong>Marks the thread pool as shutdown, and graceful shutdown the pool, by waiting for tasks to complete. A default timeout value of 10 sec is used, before shutdown becomes aggressive using<code>shutdownNow</code>, to force threads to shutdown.</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">shutdownGraceful(timeout)</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Camel 2.11:</strong>As above but with custom timeout value</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">awaitTermination</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Camel 2.11:</strong>To wait graceful for the termination of a thread pool (eg to wait for its tasks to complete). Will wait until all tasks is completed or a timeout value is hit.</p></td></tr></tbody></table></div><div class="sect3"><h4 id="ThreadingModel-SeeAlso"><a class="anchor" href="#ThreadingModel-SeeAlso"></a>See Also</h4><div class="ulist"><ul><li><p><a href="architecture.html">Architecture</a></p></li><li><p><a href="async.html">Async</a></p></li></ul></div></div></div></article></main></div><footer class="footer"><p>This page was built using the Antora default UI.</p><p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p></footer><script src="../../_/js/site.js"></script><script src="../../_/js/vendor/highlight.js"></script><script>hljs.initHighlighting()</script></body></html>