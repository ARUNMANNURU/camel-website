<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Untitled :: Apache Camel</title><link rel="canonical" href="https://camel.apache.org/manual/latest/route-policy.html"><meta name="generator" content="Antora 2.0.0"><link rel="stylesheet" href="../../_/css/site.css"></head><body class="article"><header class="header"><nav class="navbar"><div class="navbar-brand"><a class="navbar-item" href="https://camel.apache.org">Apache Camel</a><button class="navbar-burger" data-target="topbar-nav"><span></span><span></span><span></span></button></div><div id="topbar-nav" class="navbar-menu"><div class="navbar-end"><a class="navbar-item" href="#">Home</a><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Products</a><div class="navbar-dropdown"><a class="navbar-item" href="#">Product A</a><a class="navbar-item" href="#">Product B</a><a class="navbar-item" href="#">Product C</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Services</a><div class="navbar-dropdown"><a class="navbar-item" href="#">Service A</a><a class="navbar-item" href="#">Service B</a><a class="navbar-item" href="#">Service C</a></div></div><div class="navbar-item has-dropdown is-hoverable"><a class="navbar-link" href="#">Resources</a><div class="navbar-dropdown"><a class="navbar-item" href="#">Resource A</a><a class="navbar-item" href="#">Resource B</a><a class="navbar-item" href="#">Resource C</a></div></div><div class="navbar-item"><span class="control"><a class="button is-primary" href="#">Download</a></span></div></div></div></nav></header><div class="main-wrapper"><div class="navigation-container" data-component="manual" data-version="latest"><aside class="navigation"><div class="panels"><div class="navigation-menu is-active" data-panel="menu"><nav class="nav-menu"><h3 class="title"><a href="index.html">User manual</a></h3><ul class="nav-list"><li class="nav-item" data-depth="0"><ul class="nav-list"><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="getting-started.html">Getting started</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="book-getting-started.html">Getting Started with Apache Camel</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><a class="nav-link" href="architecture.html">Architecture</a><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="async.html">Async</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="asynchronous-routing-engine.html">Asynchronous Routing Engine</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="backlogdebugger.html">Backlog debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bam.html">Business Activity Monitoring</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="batch-consumer.html">Batch Consumer</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="browsable-endpoint.html">BrowsableEndpoint</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camel-core.html">Core</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="camelcontext.html">Context</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="endpoint.html">Endpoints</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="cep.html">Complex Event Processing</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="component.html">Component</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="debugger.html">Debugger</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="delay-interceptor.html">Delay interceptor</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dependency-injection.html">Dependency Injection</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="dozer-type-conversion.html">Dozer Type Conversion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="bean-integration.html">Bean Integration</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="error-handler.html">Error Handler</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange.html">Message Exchange</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="exchange-pattern.html">Exchange Pattern</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="expression.html">Expressions</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="injector.html">Injector</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="intercept.html">Intercept</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="inversion-of-control-with-smart-defaults.html">Inversion Of Control With Smart Defaults</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="lifecycle.html">Camel Lifecycle</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="oncompletion.html">OnCompletion</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="predicate.html">Predicates</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="registry.html">Registry</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="route-builder.html">RouteBuilder</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="routes.html">Routes</a></li></ul></li><li class="nav-item" data-depth="1"><button class="nav-toggle"></button><span class="nav-text">Domain Specific Languages</span><ul class="nav-list"><li class="nav-item" data-depth="2"><a class="nav-link" href="dsl.html">Camel Domain Specific Language</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="java-dsl.html">Java DSL</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="spring.html">Spring support</a></li><li class="nav-item" data-depth="2"><a class="nav-link" href="groovy-dsl.html">Groovy DSL</a></li><li class="nav-item" data-depth="2"><button class="nav-toggle"></button><span class="nav-text">Scala DSL</span><ul class="nav-list"><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl.html">About the Scala DSL</a></li><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl-getting-started.html">Getting Started</a></li><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl-eip.html">EIP</a></li><li class="nav-item" data-depth="3"><a class="nav-link" href="scala-dsl-supported-languages.html">Supported languages</a></li></ul></li></ul></li><li class="nav-item" data-depth="1"><a class="nav-link" href="using-osgi-blueprint-with-camel.html">Using OSGi blueprint with Camel</a></li></ul></li></ul></nav></div><div class="navigation-explore" data-panel="explore"><div class="context"><span class="title">User manual</span><span class="version">latest</span></div><ul class="components"><li class="component"><span class="title">Apache Camel K</span><ul class="versions"><li class="version is-latest"><a href="../../camel-k/latest/index.html">latest</a></li></ul></li><li class="component"><span class="title">Component reference</span><ul class="versions"><li class="version is-latest"><a href="../../components/latest/index.html">latest</a></li></ul></li><li class="component is-current"><span class="title">User manual</span><ul class="versions"><li class="version is-current is-latest"><a href="index.html">latest</a></li></ul></li></ul></div></div></aside></div><main class="main"><div class="toolbar" role="navigation"><button class="navigation-toggle"></button><a href="index.html" class="home-link"></a><nav class="crumbs" aria-label="breadcrumbs"></nav><div class="edit-this-page"><a href="https://github.com/apache/camel/edit/master/docs/user-manual/modules/ROOT/pages/route-policy.adoc">Edit this Page</a></div></div><article class="doc"><div class="sect2"><h3 id="RoutePolicy-RoutePolicy"><a class="anchor" href="#RoutePolicy-RoutePolicy"></a>RoutePolicy</h3><div class="paragraph"><p><strong>Available as of Camel 2.1</strong></p></div><div class="paragraph"><p>A route policy<strong><code>org.apache.camel.spi.RoutePolicy</code></strong>is used to control route(s) at runtime. For example you can use it to determine whether a route should be running or not. However the policies can support any kind of use cases.</p></div><div class="sect3"><h4 id="RoutePolicy-Howitworks"><a class="anchor" href="#RoutePolicy-Howitworks"></a>How it works</h4><div class="paragraph"><p>You associate a route with a given<strong><code>RoutePolicy</code></strong>and then during runtime Camel will invoke callbacks on this policy where you can implement your custom logic. Camel provides a support class that is a good base class to extend<strong><code>org.apache.camel.impl.RoutePolicySupport</code></strong>.</p></div><div class="paragraph"><p>There are these callbacks invoked:</p></div><div class="ulist"><ul><li><p><code>onInit</code><strong>Camel 2.3</strong></p></li><li><p><code>onRemove</code><strong>Camel 2.9</strong></p></li><li><p><code>onStart</code><strong>Camel 2.9</strong></p></li><li><p><code>onStop</code><strong>Camel 2.9</strong></p></li><li><p><code>onSuspend</code><strong>Camel 2.9</strong></p></li><li><p><code>onResume</code><strong>Camel 2.9</strong></p></li><li><p><code>onExchangeBegin</code></p></li><li><p><code>onExchangeDone</code></p></li></ul></div><div class="paragraph"><p>See the Javadoc of the<strong><code>org.apache.camel.spi.RoutePolicy</code></strong>for more details. And also the implementation of the<strong><code>org.apache.camel.impl.ThrottlingInflightRoutePolicy</code></strong>for a concrete example.</p></div><div class="paragraph"><p>Camel provides the following policies out of the box:</p></div><div class="ulist"><ul><li><p><strong><code>org.apache.camel.impl.ThrottlingInflightRoutePolicy</code></strong>- a throttling based policy that automatic suspends/resumes route(s) based on metrics from the current in flight exchanges. You can use this to dynamically throttle e.g. a<a href="jms.html">JMS</a>consumer, to avoid it consuming too fast.</p></li></ul></div><div class="paragraph"><p>As of<strong>Camel 2.5</strong>, Camel also provides an ability to schedule routes to be activated, deactivated, suspended and/or resumed at certain times during the day using a<a href="scheduledroutepolicy.html">ScheduledRoutePolicy</a>(offered via the<a href="http://camel.apache.org/quartz.html">camel-quartz</a>component).</p></div></div><div class="sect3"><h4 id="RoutePolicy-SuspendableService"><a class="anchor" href="#RoutePolicy-SuspendableService"></a>SuspendableService</h4><div class="paragraph"><p>If you want to dynamic suspend/resume routes as the<strong><code>org.apache.camel.impl.ThrottlingRoutePolicy</code></strong>does then its advised to use<strong><code>org.apache.camel.SuspendableService</code></strong>as it allows for fine grained<strong><code>suspend</code></strong>and<strong><code>resume</code></strong>operations. And use the<strong><code>org.apache.camel.util.ServiceHelper</code></strong>to aid when invoking these operations as it support fallback for regular<strong><code>org.apache.camel.Service</code></strong>instances.</p></div></div><div class="sect3"><h4 id="RoutePolicy-ThrottlingInflightRoutePolicy"><a class="anchor" href="#RoutePolicy-ThrottlingInflightRoutePolicy"></a><code>ThrottlingInflightRoutePolicy</code></h4><div class="paragraph"><p>The <strong><code>ThrottlingInflightRoutePolicy</code></strong>is triggered when an<a href="exchange.adoc">Exchange</a>is complete, which means that it requires at least one<a href="exchange.adoc">Exchange</a>to be complete before it<em>works</em>.</p></div><div class="paragraph"><p>The throttling inflight route policy has the following options:</p></div><table class="tableblock frame-all grid-all stretch"><colgroup><col style="width: 10%;"><col style="width: 90%;"></colgroup><thead><tr><th class="tableblock halign-left valign-top">Option</th><th class="tableblock halign-left valign-top">Default</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>scope</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>Route</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">A scope for either<strong><code>Route</code></strong>or<strong><code>Context</code></strong>which defines if the current number of inflight exchanges is context based or for that particular route.</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>maxInflightExchanges</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>1000</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">The maximum threshold when the throttling will start to suspend the route if the current number of inflight exchanges is higher than this value.</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>resumePercentOfMax</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>70</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">A percentage <strong><code>0..100</code></strong>which defines when the throttling should resume again in case it has been suspended.</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>loggingLevel</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>INFO</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock">The logging level used for logging the throttling activity.</p></td><td class="tableblock halign-left valign-top"><p class="tableblock"><code>logger</code></p></td></tr><tr><td class="tableblock halign-left valign-top"><p class="tableblock"><code>ThrottlingInflightRoutePolicy</code></p></td><td class="tableblock halign-left valign-top"><p class="tableblock">The logger category.</p></td></tr></tbody></table></div><div class="sect3"><h4 id="RoutePolicy-ThrottlingInflightRoutePolicy"><a class="anchor" href="#RoutePolicy-ThrottlingInflightRoutePolicy"></a>ThrottlingInflightRoutePolicy compared to the Throttler EIP</h4><div class="paragraph"><p>The<strong><code>ThrottlingInflightRoutePolicy</code></strong>compared to<a href="throttler.html">Throttler</a>is that it does<strong>not</strong>block during throttling. It does throttling that is approximate based, meaning that its more coarse grained and not explicit precise as the<a href="throttler.html">Throttler</a>. The<a href="throttler.html">Throttler</a>can be much more accurate and only allow a specific number of messages being passed per a given time unit. Also the<strong><code>ThrottlingInflightRoutePolicy</code></strong>is based its metrics on number of inflight exchanges where as<a href="throttler.html">Throttler</a>is based on number of messages per time unit.</p></div><div class="paragraph"><p>[[RoutePolicy-ScheduledRoutePolicy(SimpleandCronbased)usingcamelQuartz]] ====<code>ScheduledRoutePolicy</code>(Simple and Cron based) using camel Quartz</p></div><div class="paragraph"><p>For more details check out the following links</p></div></div><div class="sect3"><h4 id="RoutePolicy-ConfiguringPolicy"><a class="anchor" href="#RoutePolicy-ConfiguringPolicy"></a>Configuring Policy</h4><div class="paragraph"><p>You configure the route policy as follows from Java DSL, using the<strong><code>routePolicy</code></strong>method:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">  RoutePolicy myPolicy = new MyRoutePolicy();
  from("seda:foo").routePolicy(myPolicy).to("mock:result");</code></pre></div></div><div class="paragraph"><p>In Spring XML its a bit different as follows using the<strong><code>routePolicyRef</code></strong>attribute:</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">&lt;bean id="myPolicy" class="com.mycompany.MyRoutePolicy"/&gt;

&lt;route routePolicyRef="myPolicy"&gt;
    &lt;from uri="seda:foo"/&gt;
    &lt;to uri="mock:result"/&gt;
&lt;/route&gt;</code></pre></div></div></div><div class="sect3"><h4 id="RoutePolicy-ConfiguringPolicySets"><a class="anchor" href="#RoutePolicy-ConfiguringPolicySets"></a>Configuring Policy Sets</h4><div class="paragraph"><p><strong>Available as of Camel 2.7</strong></p></div><div class="paragraph"><p><strong><code>RoutePolicy</code></strong>has been further improved to allow addition of policy sets or a collection of policies that are concurrently applied on a route. The addition of policies is done as follows.</p></div><div class="paragraph"><p>In the example below, the route <strong><code>testRoute</code></strong>has a <strong><code>startPolicy</code></strong>and <strong><code>throttlePolicy</code></strong>applied concurrently. Both policies are applied as necessary on the route.</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">&lt;bean id="date" class="org.apache.camel.routepolicy.quartz.SimpleDate"/&gt;

&lt;bean id="startPolicy" class="org.apache.camel.routepolicy.quartz.SimpleScheduledRoutePolicy"&gt;
  &lt;property name="routeStartDate" ref="date"/&gt;
  &lt;property name="routeStartRepeatCount" value="1"/&gt;
  &lt;property name="routeStartRepeatInterval" value="3000"/&gt;
&lt;/bean&gt;

&lt;bean id="throttlePolicy" class="org.apache.camel.impl.ThrottlingInflightRoutePolicy"&gt;
  &lt;property name="maxInflightExchanges" value="10"/&gt;
&lt;/bean&gt;

&lt;camelContext id="testRouteContext" xmlns="http://camel.apache.org/schema/spring"&gt;
  &lt;route id="testRoute" autoStartup="false" routePolicyRef="startPolicy, throttlePolicy"&gt;
    &lt;from uri="seda:foo?concurrentConsumers=20"/&gt;
    &lt;to uri="mock:result"/&gt;
  &lt;/route&gt;
&lt;/camelContext&gt;</code></pre></div></div></div><div class="sect3"><h4 id="RoutePolicy-UsingRoutePolicyFactory"><a class="anchor" href="#RoutePolicy-UsingRoutePolicyFactory"></a>Using <code>RoutePolicyFactory</code></h4><div class="paragraph"><p><strong>Available as of Camel 2.14</strong></p></div><div class="paragraph"><p>If you want to use a route policy for every route, you can use a <strong><code>org.apache.camel.spi.RoutePolicyFactory</code></strong>as a factory for creating a <strong><code>RoutePolicy</code></strong>instance for each route. This can be used when you want to use the same kind of route policy for every routes. Then you need to only configure the factory once, and every route created will have the policy assigned.</p></div><div class="paragraph"><p>There is API on CamelContext to add a factory, as shown below</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">context.addRoutePolicyFactory(new MyRoutePolicyFactory());</code></pre></div></div><div class="paragraph"><p>And from XML DSL you just define a <strong><code>&lt;bean&gt;</code></strong>with the factory</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">&lt;bean id="myRoutePolicyFactory" class="com.foo.MyRoutePolicyFactory"/&gt;</code></pre></div></div><div class="paragraph"><p>The factory has a single method that creates the route policy</p></div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    /**
     * Creates a new {@link org.apache.camel.spi.RoutePolicy} which will be assigned to the given route.
     *
     * @param camelContext the camel context
     * @param routeId      the route id
     * @param route        the route definition
     * @return the created {@link org.apache.camel.spi.RoutePolicy}, or &lt;tt&gt;null&lt;/tt&gt; to not use a policy for this route
     */
    RoutePolicy createRoutePolicy(CamelContext camelContext, String routeId, RouteDefinition route);</code></pre></div></div><div class="paragraph"><p>Note you can have as many route policy factories as you want. Just call the <strong><code>addRoutePolicyFactory</code></strong>again, or declare the other factories as <strong><code>&lt;bean&gt;</code></strong>in XML.</p></div></div><div class="sect3"><h4 id="RoutePolicy-SeeAlso"><a class="anchor" href="#RoutePolicy-SeeAlso"></a>See Also</h4><div class="ulist"><ul><li><p><a href="route-throttling-example.html">Route Throttling Example</a>for an example using this in practice with the <strong><code>ThrottlingInflightRoutePolicy</code></strong></p></li><li><p><a href="scheduledroutepolicy.html">ScheduledRoutePolicy</a>for information on policy based scheduling capability for camel routes</p></li><li><p><a href="metrics-component.html">MetricsRoutePolicyFactory</a>for information on a policy using the metrics component to expose route statistics using the metrics library.</p></li><li><p><a href="architecture.html">Architecture</a></p></li></ul></div></div></div></article></main></div><footer class="footer"><p>This page was built using the Antora default UI.</p><p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p></footer><script src="../../_/js/site.js"></script><script src="../../_/js/vendor/highlight.js"></script><script>hljs.initHighlighting()</script></body></html>